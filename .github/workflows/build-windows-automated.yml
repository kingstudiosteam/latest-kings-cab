name: Automated Windows Build & Installer Creation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup CMake
      uses: lukka/get-cmake@latest
    
    - name: Configure CMake for Windows
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DJUCE_BUILD_EXTRAS=OFF -DJUCE_BUILD_EXAMPLES=OFF -DJUCE_FETCH_VST3_SDK=ON
    
    - name: Build Windows Plugins
      run: |
        cd build
        cmake --build . --config Release --parallel 4
    
    - name: Verify Windows Builds
      run: |
        echo "Checking Windows plugin builds..."
        ls -la "TheKingsCab_artefacts/Release/VST3/"
        ls -la "TheKingsCab_artefacts/Release/AAX/"
        echo "âœ… Windows plugins built successfully!"
    
    - name: Create Windows Installer Structure
      run: |
        mkdir -p installers/windows/plugins/VST3
        mkdir -p installers/windows/plugins/AAX
        mkdir -p installers/windows/ir_collections
        
        # Copy Windows VST3
        cp -r "TheKingsCab_artefacts/Release/VST3/The King's Cab.vst3" "installers/windows/plugins/VST3/"
        
        # Copy Windows AAX
        cp -r "TheKingsCab_artefacts/Release/AAX/The King's Cab.aaxplugin" "installers/windows/plugins/AAX/"
        
        echo "âœ… Windows installer structure created!"
    
    - name: Create Windows Installer Script
      run: |
        echo "Creating Windows installer script..."
        echo '@echo off' > installers/windows/install.bat
        echo 'setlocal EnableDelayedExpansion' >> installers/windows/install.bat
        echo 'color 0F' >> installers/windows/install.bat
        echo 'title The King'\''s Cab Installer v1.0.0' >> installers/windows/install.bat
        echo '' >> installers/windows/install.bat
        echo 'echo.' >> installers/windows/install.bat
        echo 'echo ========================================================' >> installers/windows/install.bat
        echo 'echo      The King'\''s Cab v1.0.0 - Professional Installer' >> installers/windows/install.bat
        echo 'echo                    King Studios' >> installers/windows/install.bat
        echo 'echo ========================================================' >> installers/windows/install.bat
        echo 'echo.' >> installers/windows/install.bat
        echo 'echo ðŸŽ¸ Installing professional cabinet simulator...' >> installers/windows/install.bat
        echo 'echo.' >> installers/windows/install.bat
        echo '' >> installers/windows/install.bat
        echo ':: Check if running as administrator' >> installers/windows/install.bat
        echo 'net session >nul 2>&1' >> installers/windows/install.bat
        echo 'if %errorLevel% neq 0 (' >> installers/windows/install.bat
        echo '    echo âŒ ERROR: This installer requires administrator privileges' >> installers/windows/install.bat
        echo '    echo    Please right-click and "Run as administrator"' >> installers/windows/install.bat
        echo '    echo.' >> installers/windows/install.bat
        echo '    pause' >> installers/windows/install.bat
        echo '    exit /b 1' >> installers/windows/install.bat
        echo ')' >> installers/windows/install.bat
        echo '' >> installers/windows/install.bat
        echo ':: Create installation directories' >> installers/windows/install.bat
        echo 'echo ðŸ“ Creating installation directories...' >> installers/windows/install.bat
        echo 'if not exist "C:\Program Files\Common Files\VST3" mkdir "C:\Program Files\Common Files\VST3"' >> installers/windows/install.bat
        echo 'if not exist "C:\Program Files\Common Files\Avid\Audio\Plug-Ins" mkdir "C:\Program Files\Common Files\Avid\Audio\Plug-Ins"' >> installers/windows/install.bat
        echo 'if not exist "C:\ProgramData\King Studios\The King'\''s Cab\IR Collections" mkdir "C:\ProgramData\King Studios\The King'\''s Cab\IR Collections"' >> installers/windows/install.bat
        echo '' >> installers/windows/install.bat
        echo ':: Install VST3 Plugin' >> installers/windows/install.bat
        echo 'echo ðŸ”Œ Installing VST3 plugin...' >> installers/windows/install.bat
        echo 'if exist "plugins\VST3\The King'\''s Cab.vst3" (' >> installers/windows/install.bat
        echo '    xcopy /E /Y "plugins\VST3\The King'\''s Cab.vst3" "C:\Program Files\Common Files\VST3\"' >> installers/windows/install.bat
        echo '    echo âœ… VST3 plugin installed successfully' >> installers/windows/install.bat
        echo ') else (' >> installers/windows/install.bat
        echo '    echo âŒ VST3 plugin files not found' >> installers/windows/install.bat
        echo ')' >> installers/windows/install.bat
        echo '' >> installers/windows/install.bat
        echo ':: Install AAX Plugin' >> installers/windows/install.bat
        echo 'echo ðŸ”Œ Installing AAX plugin for ProTools...' >> installers/windows/install.bat
        echo 'if exist "plugins\AAX\The King'\''s Cab.aaxplugin" (' >> installers/windows/install.bat
        echo '    xcopy /E /Y "plugins\AAX\The King'\''s Cab.aaxplugin" "C:\Program Files\Common Files\Avid\Audio\Plug-Ins\"' >> installers/windows/install.bat
        echo '    echo âœ… AAX plugin installed successfully' >> installers/windows/install.bat
        echo ') else (' >> installers/windows/install.bat
        echo '    echo âŒ AAX plugin files not found' >> installers/windows/install.bat
        echo ')' >> installers/windows/install.bat
        echo '' >> installers/windows/install.bat
        echo ':: Install IR Collections' >> installers/windows/install.bat
        echo 'echo ðŸŽµ Installing IR Collections...' >> installers/windows/install.bat
        echo 'if exist "ir_collections" (' >> installers/windows/install.bat
        echo '    xcopy /E /Y "ir_collections\*" "C:\ProgramData\King Studios\The King'\''s Cab\IR Collections\"' >> installers/windows/install.bat
        echo '    echo âœ… IR Collections installed successfully' >> installers/windows/install.bat
        echo ') else (' >> installers/windows/install.bat
        echo '    echo âŒ IR Collections not found' >> installers/windows/install.bat
        echo ')' >> installers/windows/install.bat
        echo '' >> installers/windows/install.bat
        echo ':: Create Start Menu shortcut' >> installers/windows/install.bat
        echo 'echo ðŸ”— Creating Start Menu entry...' >> installers/windows/install.bat
        echo 'if not exist "%APPDATA%\Microsoft\Windows\Start Menu\Programs\King Studios" mkdir "%APPDATA%\Microsoft\Windows\Start Menu\Programs\King Studios"' >> installers/windows/install.bat
        echo 'echo [InternetShortcut] > "%APPDATA%\Microsoft\Windows\Start Menu\Programs\King Studios\King Studios Store.url"' >> installers/windows/install.bat
        echo 'echo URL=https://www.kingstudiospa.com/store >> "%APPDATA%\Microsoft\Windows\Start Menu\Programs\King Studios\King Studios Store.url"' >> installers/windows/install.bat
        echo '' >> installers/windows/install.bat
        echo ':: Register with Windows' >> installers/windows/install.bat
        echo 'echo ðŸ“ Registering with Windows...' >> installers/windows/install.bat
        echo 'reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\The King'\''s Cab" /v "DisplayName" /t REG_SZ /d "The King'\''s Cab v1.0.0" /f >nul' >> installers/windows/install.bat
        echo 'reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\The King'\''s Cab" /v "Publisher" /t REG_SZ /d "King Studios" /f >nul' >> installers/windows/install.bat
        echo 'reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\The King'\''s Cab" /v "DisplayVersion" /t REG_SZ /d "1.0.0" /f >nul' >> installers/windows/install.bat
        echo 'reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\The King'\''s Cab" /v "URLInfoAbout" /t REG_SZ /d "https://www.kingstudiospa.com" /f >nul' >> installers/windows/install.bat
        echo '' >> installers/windows/install.bat
        echo 'echo.' >> installers/windows/install.bat
        echo 'echo ========================================================' >> installers/windows/install.bat
        echo 'echo          ðŸŽ‰ INSTALLATION COMPLETED SUCCESSFULLY! ðŸŽ‰' >> installers/windows/install.bat
        echo 'echo ========================================================' >> installers/windows/install.bat
        echo 'echo.' >> installers/windows/install.bat
        echo 'echo âœ… The King'\''s Cab has been installed to your system' >> installers/windows/install.bat
        echo 'echo âœ… VST3 plugin available in all compatible DAWs' >> installers/windows/install.bat
        echo 'echo âœ… AAX plugin available in ProTools' >> installers/windows/install.bat
        echo 'echo âœ… 500+ Professional IR collection installed' >> installers/windows/install.bat
        echo 'echo âœ… Start Menu shortcuts created' >> installers/windows/install.bat
        echo 'echo.' >> installers/windows/install.bat
        echo 'echo ðŸŽ¸ Launch your DAW and look for "The King'\''s Cab" in plugins' >> installers/windows/install.bat
        echo 'echo ðŸŒ Visit: https://www.kingstudiospa.com/store for more products' >> installers/windows/install.bat
        echo 'echo.' >> installers/windows/install.bat
        echo 'echo Press any key to exit...' >> installers/windows/install.bat
        echo 'pause >nul' >> installers/windows/install.bat
        echo "âœ… Windows installer script created!"
    
    - name: Create Windows Installer Package
      run: |
        cd installers/windows
        powershell -Command "Compress-Archive -Path * -DestinationPath 'TheKingsCab-Windows-Complete.zip' -Force"
        echo "âœ… Windows installer package created!"
    
    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: TheKingsCab-Windows-Complete
        path: installers/windows/TheKingsCab-Windows-Complete.zip
        if-no-files-found: error
    
    - name: Upload Individual Plugins
      uses: actions/upload-artifact@v4
      with:
        name: Windows-VST3-AAX-Plugins
        path: |
          build/TheKingsCab_artefacts/Release/VST3/
          build/TheKingsCab_artefacts/Release/AAX/
        if-no-files-found: error
    
    - name: Build Summary
      run: |
        echo "ðŸŽ‰ BUILD COMPLETED SUCCESSFULLY!"
        echo "================================="
        echo "âœ… Windows VST3 plugin built"
        echo "âœ… Windows AAX plugin built" 
        echo "âœ… Windows installer package created"
        echo "âœ… All artifacts uploaded to GitHub"
        echo ""
        echo "ðŸ“¦ Download the installer from the Actions tab"
        echo "ðŸŽ¸ Plugins ready for Cakewalk, ProTools, and all DAWs!"
